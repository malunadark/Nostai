<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nostai</title>

  <!-- Фавикон -->
  <link rel="icon" href="assets/images/Nostai.png" type="image/png">

  <!-- Стили -->
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: url("assets/images/Nostai.png") no-repeat center center fixed;
      background-size: cover;
      font-family: 'Deutsch Gothic', sans-serif;
    }

    #scene {
      display: block;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>

<body>
  <canvas id="scene"></canvas>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

    // Сцена
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.03); // лёгкий туман

    // Камера
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(0, 2, 7);

    // Рендер
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("scene"), alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    // Контролы (только для теста)
    // const controls = new OrbitControls(camera, renderer.domElement);

    // Освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const spotLight = new THREE.SpotLight(0xffaa88, 1);
    spotLight.position.set(10, 15, 10);
    spotLight.castShadow = true;
    scene.add(spotLight);

    // Загрузка GLTF дверей
    const loader = new GLTFLoader();
    const doorsData = [
      { name: "Хроники Забвения", path: "assets/3d/door1.glb", x: -4 },
      { name: "Порог Тайны", path: "assets/3d/door2.glb", x: -1.3 },
      { name: "Голос Тени", path: "assets/3d/door3.glb", x: 1.3 },
      { name: "Дары Провидцев", path: "assets/3d/door4.glb", x: 4 }
    ];

    const doors = [];

    doorsData.forEach(d => {
      loader.load(d.path, gltf => {
        const door = gltf.scene;
        door.position.set(d.x, 0, 0);
        door.name = d.name;
        door.traverse(child => { if(child.isMesh) child.castShadow = true; });
        scene.add(door);
        doors.push(door);
      });
    });

    // Raycaster для наведения мыши
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function onMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
    }
    window.addEventListener("mousemove", onMouseMove, false);

    // Клик по двери
    window.addEventListener("click", () => {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(doors, true);
      if(intersects.length > 0){
        alert("Вы выбрали: " + intersects[0].object.parent.name);
        // Здесь будет переход на кат-сцену
      }
    });

    // Анимация
    function animate() {
      requestAnimationFrame(animate);

      // Подсветка при наведении
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(doors, true);
      doors.forEach(door => {
        door.traverse(mesh => {
          if(mesh.isMesh) mesh.material.emissive && (mesh.material.emissive.setHex(0x000000));
        });
      });
      intersects.forEach(i => {
        i.object.material.emissive && i.object.material.emissive.setHex(0x4444ff);
      });

      renderer.render(scene, camera);
    }
    animate();

    // Адаптация под окно
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

  </script>
</body>
</html>
